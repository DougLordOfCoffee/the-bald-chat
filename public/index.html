<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Bald Chat — Inside The Dome</title>

  <!-- firebase compat libraries (same style you used) -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1724;
      --muted:#94a3b8;
      --accent:#7c3aed;
      --danger:#ff6b6b;
      --bubble:#0b1a2b;
      --me-bubble:#13293d;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #071026 0%, #081328 100%);
      color:#e6eef8;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .card{
      width:100%;
      max-width:980px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:18px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:46px;height:46px;border-radius:999px;
      background:linear-gradient(135deg,var(--accent),#4f46e5);
      display:flex;align-items:center;justify-content:center;font-weight:700;
      font-family:var(--mono);color:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.06);
    }
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted)}

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .username {
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      padding:8px 12px;
      border-radius:10px;
      color:inherit;
      min-width:200px;
    }

    .status{
      display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)
    }
    .dot {
      width:10px;height:10px;border-radius:50%;
      background:var(--danger);box-shadow:0 0 6px rgba(0,0,0,0.6);
    }
    .dot.connected{ background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.2)}

    .main{
      display:flex;gap:18px;
      height:550px;
    }

    .messages {
      flex:1;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
      border-radius:12px;
      padding:12px;
      overflow:auto;
      border:1px solid rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .sidebar{
      width:260px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .composer{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding-top:8px;
    }

    textarea.message-input{
      flex:1;
      min-height:48px;
      max-height:150px;
      padding:12px;
      border-radius:12px;
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.03);
      color:inherit;
      resize:vertical;
      outline:none;
      font-size:14px;
    }
    button.send{
      background:linear-gradient(180deg,var(--accent),#5b21b6);
      color:white;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;
      font-weight:600;
      box-shadow:0 8px 24px rgba(92,33,164,0.12);
    }
    button.send:active{transform:translateY(1px)}

    .msg {
      display:flex;
      gap:10px;
      align-items:flex-start;
      max-width:85%;
      transition:transform .12s ease,opacity .12s ease;
    }

    .msg.me { margin-left:auto; flex-direction:row-reverse; max-width:90% }
    .bubble{
      background:var(--bubble);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.02);
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      display:flex;flex-direction:column;gap:6px;
    }
    .msg.me .bubble { background:var(--me-bubble); border:1px solid rgba(255,255,255,0.03) }

    .meta { display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted) }
    .avatar{
      width:44px;height:44px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700;
      color:white;font-family:var(--mono);flex-shrink:0;border:1px solid rgba(255,255,255,0.04)
    }
    .username-text{font-weight:700;font-size:13px}
    .text{white-space:pre-wrap;word-break:break-word;font-size:14px;line-height:1.35}
    .msg .actions{
      display:flex;gap:6px;align-items:center;margin-left:8px;
    }
    .small-btn{
      border:none;background:transparent;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px;
    }
    .small-btn:hover{ color: #fff; background: rgba(255,255,255,0.02) }

    /* toast */
    #toast{
      position:fixed;right:20px;bottom:20px;background:#0b1220;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);opacity:0;transform:translateY(8px);transition:all .28s ease;pointer-events:none;
    }
    #toast.show{opacity:1;transform:translateY(0);pointer-events:auto;color:#e6eef8}

    footer{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:13px;color:var(--muted)}
    @media (max-width:860px){
      .main{flex-direction:column;height:72vh}
      .sidebar{width:100%}
    }
  </style>
</head>
<body>
  <div class="card" role="application" aria-labelledby="app-title">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">BD</div>
        <div>
          <h1 id="app-title">Inside The Dome</h1>
          <div class="sub">A tiny chat for bald minds</div>
        </div>
      </div>

      <div class="controls">
        <input id="usernameInput" class="username" aria-label="Your username" placeholder="Enter your username (saved locally)" />
        <div class="status" aria-live="polite">
          <div id="connDot" class="dot" title="Connection status"></div>
          <div id="statusText">Connecting...</div>
        </div>
      </div>
    </header>

    <div class="main">
      <div class="messages" id="messages" aria-live="polite" aria-relevant="additions removals">
        <!-- messages go here -->
      </div>

      <aside class="sidebar" aria-hidden="false">
        <div style="background:var(--panel);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.02)">
          <div style="font-weight:700">Info</div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">
            Messages are saved to Firebase Realtime Database. You get an anonymous id per browser; you'll only be able to delete messages you created.
          </div>
        </div>

        <div style="background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)">
          <div style="font-weight:700">Stats</div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">
            <div>Messages: <span id="messageCount">0</span></div>
            <div>Connected UID: <span id="uidShort" style="font-family:var(--mono);color:var(--muted)">—</span></div>
          </div>
        </div>

        <div style="margin-top:auto">
          <div style="font-size:12px;color:var(--muted)">Tips</div>
          <ul style="margin:8px 0 0 16px;color:var(--muted);font-size:13px">
            <li>Enter to send, Shift+Enter for newline</li>
            <li>Username saved locally</li>
            <li>Only you can delete your messages</li>
          </ul>
        </div>
      </aside>
    </div>

    <div class="composer" role="region" aria-label="Message composer">
      <textarea id="messageInput" class="message-input" placeholder="Type your message... (Shift+Enter for newline)"></textarea>
      <button id="sendMessage" class="send" aria-label="Send message">Send</button>
    </div>

    <footer>
      <div class="sub">Powered by Your Dome • Be nice to bald heads</div>
      <div class="sub">Local saves • Anonymous auth</div>
    </footer>
  </div>

  <div id="toast" role="status" aria-live="polite">Saved</div>

  <script>
    // --- Firebase Configuration (kept your config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAANuaXF-zSqAs9kzIBnW3ROLDwxGXA1p8",
      authDomain: "the-bald-chat.firebaseapp.com",
      projectId: "the-bald-chat",
      storageBucket: "the-bald-chat.firebasestorage.app",
      messagingSenderId: "831148484483",
      appId: "1:831148484483:web:23747c98adcd6e989db8b6",
      databaseURL: "https://the-bald-chat-default-rtdb.firebaseio.com"
    };

    // --- Globals / DOM refs ---
    let database, currentUid = null;
    const usernameInput = document.getElementById('usernameInput');
    const messageInput  = document.getElementById('messageInput');
    const sendBtn       = document.getElementById('sendMessage');
    const messagesDiv   = document.getElementById('messages');
    const toastEl       = document.getElementById('toast');
    const connDot       = document.getElementById('connDot');
    const statusText    = document.getElementById('statusText');
    const messageCountEl= document.getElementById('messageCount');
    const uidShortEl    = document.getElementById('uidShort');

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();

    // --- Username memory with toast ---
    function loadUsername() {
      const saved = localStorage.getItem('username');
      if (saved) usernameInput.value = saved;
    }
    function saveUsername() {
      const v = usernameInput.value.trim();
      if (!v) {
        showToast('Username cleared');
        localStorage.removeItem('username');
        return;
      }
      localStorage.setItem('username', v);
      showToast('Username saved!');
    }
    usernameInput.addEventListener('blur', saveUsername);
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveUsername();
        messageInput.focus();
      }
    });

    // --- Toast helper ---
    let toastTimer = null;
    function showToast(msg, ms=1800) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove('show'), ms);
    }

    // --- Utility: color avatar from text ---
    function stringToColor(s) {
      let h = 0;
      for (let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5) - h);
      const hue = Math.abs(h) % 360;
      return `linear-gradient(135deg,hsl(${hue} 70% 45%), hsl(${(hue+40)%360} 70% 35%))`;
    }
    function avatarInitials(name){
      if (!name) return 'AN';
      const parts = name.split(/\s+/).filter(Boolean);
      if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0]+parts[1][0]).toUpperCase();
    }

    // --- Send message ---
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const username = (usernameInput.value.trim() || 'Anonymous');
      const msgRef = database.ref('messages').push();
      const payload = {
        username,
        text,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        ownerId: currentUid || null
      };
      try {
        await msgRef.set(payload);
        messageInput.value = '';
        messageInput.focus();
      } catch (err) {
        console.error('write error', err);
        showToast('Failed to send');
      }
    }

    // --- Format time ---
    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' });
    }

    // --- Create DOM message ---
    function createMessageElement(id, data) {
      // id is snapshot key
      const container = document.createElement('div');
      container.className = 'msg' + (data.ownerId && data.ownerId === currentUid ? ' me' : '');
      container.id = 'msg-' + id;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.style.background = stringToColor(data.username || 'Anon');
      avatar.textContent = avatarInitials(data.username || 'Anon');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const meta = document.createElement('div');
      meta.className = 'meta';
      const uname = document.createElement('div');
      uname.className = 'username-text';
      uname.textContent = data.username || 'Anonymous';

      const time = document.createElement('div');
      time.style.marginLeft = '8px';
      time.textContent = formatTimestamp(data.timestamp) || '';
      time.title = data.timestamp ? new Date(data.timestamp).toLocaleString() : '';

      meta.appendChild(uname);
      meta.appendChild(time);

      const textEl = document.createElement('div');
      textEl.className = 'text';
      textEl.textContent = data.text || '';

      const actions = document.createElement('div');
      actions.className = 'actions';

      // Delete button only shown if ownerId matches currentUid
      if (data.ownerId && currentUid && data.ownerId === currentUid) {
        const del = document.createElement('button');
        del.className = 'small-btn';
        del.title = 'Delete your message';
        del.textContent = '❌';
        del.addEventListener('click', async () => {
          if (!confirm('Delete this message?')) return;
          try {
            await database.ref('messages').child(id).remove();
            showToast('Message deleted', 1200);
          } catch (err) {
            console.error('delete failed', err);
            showToast('Delete failed');
          }
        });
        actions.appendChild(del);
      }

      bubble.appendChild(meta);
      bubble.appendChild(textEl);

      container.appendChild(avatar);
      container.appendChild(bubble);
      container.appendChild(actions);

      return container;
    }

    // --- Listeners for realtime updates ---
    let messageCount = 0;
    function attachDatabaseListeners() {
      const ref = database.ref('messages');

      // ordering by timestamp - show recent first? We'll use timestamp ascending
      ref.off(); // ensure no double listeners

      ref.on('child_added', (snap) => {
        const id = snap.key;
        const data = snap.val() || {};
        // ignore if already present (safety)
        if (document.getElementById('msg-' + id)) return;
        const el = createMessageElement(id, data);
        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        messageCount++;
        messageCountEl.textContent = messageCount;
      });

      ref.on('child_removed', (snap) => {
        const id = snap.key;
        const dom = document.getElementById('msg-' + id);
        if (dom) dom.remove();
        messageCount = Math.max(0, messageCount - 1);
        messageCountEl.textContent = messageCount;
      });

      ref.on('child_changed', (snap) => {
        const id = snap.key;
        const data = snap.val() || {};
        const dom = document.getElementById('msg-' + id);
        if (dom) {
          // rebuild bubble quickly
          const newDom = createMessageElement(id, data);
          dom.replaceWith(newDom);
        }
      });

      // maintain initial count
      ref.once('value').then(snap => {
        messageCount = snap.numChildren() || 0;
        messageCountEl.textContent = messageCount;
      }).catch(()=>{});
    }

    // --- Auth + connection monitoring ---
    function initAuthAndConnections() {
      // sign in anonymously if not signed in
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          currentUid = user.uid;
          uidShortEl.textContent = currentUid ? (currentUid.slice(0,6) + '…') : '—';
          connDot.classList.add('connected');
          statusText.textContent = 'Connected';
          attachDatabaseListeners();
        } else {
          // sign in
          firebase.auth().signInAnonymously().catch((err) => {
            console.error('auth failed', err);
            showToast('Auth failed');
          });
        }
      });

      // connection state from the Realtime DB
      const conRef = database.ref('.info/connected');
      conRef.on('value', (snap) => {
        const val = snap.val();
        if (val === true) {
          connDot.classList.add('connected');
          statusText.textContent = 'Connected';
        } else {
          connDot.classList.remove('connected');
          statusText.textContent = 'Disconnected';
        }
      });
    }

    // --- Keybindings & UI wiring ---
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // keep focus UX nice
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== messageInput && document.activeElement !== usernameInput) {
        e.preventDefault();
        messageInput.focus();
      }
    });

    // --- Boot ---
    loadUsername();
    initAuthAndConnections();
    showToast('Welcome to The Bald Chat!', 1800);
    // focus message input on start
    setTimeout(()=> messageInput.focus(), 400);

    // optional: debug helper in console
    window._baldChat = {
      db: database,
      firebase
    };
  </script>
</body>
</html>
